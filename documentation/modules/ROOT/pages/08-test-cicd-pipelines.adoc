= Deploy CICD Pipelines With GitOps
include::_attributes.adoc[]

[#checking-cicd-pipelines]
== Checking pipelines

Well so far we have used the command line to create the ArgoCD root application that in its turn has created all the needed elements:

- Cluster Tasks
- Pipelines
- Triggers

All those elements have been created in namespace devoted to CICD, let's have a look at the pipelines. Open the OpenShift web console and navigate to the CICD project (_red arrow_).

NOTE: Make sure that on the upper left corner the "Administrator" view is selected and that you are in the *'Home->Projects'* section.

image::pipelines-check-1.png[Pipelines Check 1]

Now navigate to 'Pipelines->Pipelines'. As you can see there are CI and CD pipelines for each microservice.

image::pipelines-check-2.png[Pipelines Check 2]

Le's have a look to the *CI pipeline* for the `Events` microservice *'events-ci-pl'*. As you can see is made of a series of tasks:

- *fetch-repository:* Fetches the `Events` code fro the Gitea repository you migrated before
- *package:* Compiles and packages the code in a JAR file
- *build:* Builds a container image, pushes it to the registry of images and saves the hash in an output variable
- *fetch-config-repository:* Fetches the configuration of Gramola (remember git is the source of truth for ArgoCD)
- *update-image:* Updates the hash in the *kustomization file* in the `dev` overlay of `Events` but in a short lived feature branch
- *gitea-pr-create:* Creates a *Pull Request* with the *feature branch* over the *main branch*
- *github-pr-create:* _N/A in this case we use Gitea_

NOTE: This is just an example covering the bare minimum tasks of a CI pipeline! Of course there should be other critical tasks such as: unit testing, code quality, ...

image::pipelines-check-3.png[Pipelines Check 3]

Navigate back and open the *CD pipeline*, again for `Events`, called *'events-cd-pl'*. This time the list of tasks is even shorter...

- *argocd-sync:* This triggers both the refresh from the configuration git repository and the assets synchronization
- *fetch-config-repository:* Fetches the configuration of Gramola (remember git is the source of truth for ArgoCD)
- *update-image:* Updates the hash in the *kustomization file* in the `dev` overlay of `Events` but in a short lived feature branch
- *gitea-pr-create:* Creates a *Pull Request* with the *feature branch* over the *main branch*
- *github-pr-create:* _N/A in this case we use Gitea_

image::pipelines-check-4.png[Pipelines Check 4]

Finally if you navigate to 'Pipelines->Triggers' you'll see there are many of them, we'll only use those for Gitea but the example is ready for receiving events from GitHub and GitLab. 

image::pipelines-check-5.png[Pipelines Check 5]

Well triggers are in place but we need web hooks to feed them!

[#create-pipelines-web-hooks]
== Create Pipelines Web Hooks

include::partial$gitea-create-webhooks.adoc[]

[#check-ci-web-hook]
== Check CI Web Hook

Let’s check the webhook is working:

[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc logs -f deployment/el-events-ci-pl-push-listener -n ${CICD_NAMESPACE}
----

You should get something like this, pay attention to one of the last
lines saying *``event type ping is not allowed''*.

[.console-input]
[source,bash, subs="+macros,+attributes"]
----
...
{"level":"info","ts":"2021-08-26T15:31:19.005Z","logger":"eventlistener","caller":"sink/sink.go:213","msg":"interceptor stopped trigger processing: rpc error: code = FailedPrecondition desc = event type ping is not allowed","knative.dev/controller":"eventlistener","/triggers-eventid":"c5b06856-471d-43e5-9892-2d812b23e1ac","/trigger":"github-listener"}
----

Now if you push a change in the code the CI pipeline for `events` should
we kicked off.

If you haven’t stopped the log output you should see something like:

[.console-input]
[source,bash, subs="+macros,+attributes"]
----
...
{"level":"info","ts":"2021-08-26T15:37:54.796Z","logger":"eventlistener","caller":"resources/create.go:95","msg":"Generating resource: kind: &APIResource{Name:pipelineruns,Namespaced:true,Kind:PipelineRun,Verbs:[delete deletecollection get list patch create update watch],ShortNames:[pr prs],SingularName:pipelinerun,Categories:[tekton tekton-pipelines],Group:tekton.dev,Version:v1beta1,StorageVersionHash:RcAKAgPYYoo=,}, name: events-ci-pl-push-plr-","knative.dev/controller":"eventlistener"}
{"level":"info","ts":"2021-08-26T15:37:54.796Z","logger":"eventlistener","caller":"resources/create.go:103","msg":"For event ID \"57d7515c-f954-43ee-b99b-bf53a1578058\" creating resource tekton.dev/v1beta1, Resource=pipelineruns","knative.dev/controller":"eventlistener"}
----

Stop the log output with `Ctrl+C`.

We have to do the same for the `gateway` service, you now the drill,
let’s get the route host got the listener.

[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc get route/el-gateway-ci-pl-push-listener -n ${CICD_NAMESPACE} -o jsonpath='{.status.ingress[0].host}' && echo ""
----

This time go to the `gramola-gateway` repo and create a webhook like we
did before but using the host you just got.

Again as we did for `gramola-events` let’s have a look to the logs of
the listener:

[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc logs -f deployment/el-gateway-ci-pl-push-listener -n ${CICD_NAMESPACE}
----

If it all went well you should see this:

[.console-input]
[source,bash, subs="+macros,+attributes"]
----
...
{"level":"info","ts":"2021-08-26T15:58:30.986Z","logger":"eventlistener","caller":"sink/sink.go:213","msg":"interceptor stopped trigger processing: rpc error: code = FailedPrecondition desc = event type ping is not allowed","knative.dev/controller":"eventlistener","/triggers-eventid":"bf2144ab-d3ca-471c-a340-9d9ae9e150e4","/trigger":"github-listener"}
----

Now make a change to the code of `gramola-gateway` and let’s see if the
pipeline is triggered or not.

[.console-input]
[source,bash, subs="+macros,+attributes"]
----
...
{"level":"info","ts":"2021-08-26T16:03:26.383Z","logger":"eventlistener","caller":"resources/create.go:95","msg":"Generating resource: kind: &APIResource{Name:pipelineruns,Namespaced:true,Kind:PipelineRun,Verbs:[delete deletecollection get list patch create update watch],ShortNames:[pr prs],SingularName:pipelinerun,Categories:[tekton tekton-pipelines],Group:tekton.dev,Version:v1beta1,StorageVersionHash:RcAKAgPYYoo=,}, name: gateway-ci-pl-push-plr-","knative.dev/controller":"eventlistener"}
{"level":"info","ts":"2021-08-26T16:03:26.383Z","logger":"eventlistener","caller":"resources/create.go:103","msg":"For event ID \"de0712e7-9d0e-4896-87a2-1058047fe7ce\" creating resource tekton.dev/v1beta1, Resource=pipelineruns","knative.dev/controller":"eventlistener"}
----

== Creating Web Hooks for the Cd Pipelines

Continuos Delivery pipelines are triggered once a PR to the
configuration repository `gramola` changing the image of a deployment
has been merged. This means we have to create webhooks for this type of
event for all the services that comprises `gramola`, our application:

Go to github to the gramola repo:

Go to Settings

Go to Web Hooks

Annotate route to the CD pipeline, the one triggered with PR that
changes the image of `events`.

[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc get route/el-events-cd-pl-pr-listener -n ${CICD_NAMESPACE} -o jsonpath='{.status.ingress[0].host}' && echo ""
----

Expect something like:

[.console-input]
[source,bash, subs="+macros,+attributes"]
----
el-events-cd-pl-pr-listener-gramola-cicd.apps.acme.com
----

Create Web Hook (click on Add Webhook) - Payload URL, the URL of the
route of the trigger listener you just got (don’t forget the `http://`
part, it’s NOT `https://`) - Type a secret… any thing should work -
Click on Let me…. and select Pull Requests and deselect Push Events…

Click on `Add webhook`

Let’s check the webhook is working:

[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc logs -f deployment/el-events-cd-pl-pr-listener -n ${CICD_NAMESPACE}
----

You should get something like this, pay attention to one of the last
lines saying *``event type ping is not allowed''*.

[.console-input]
[source,bash, subs="+macros,+attributes"]
----
...
{"level":"info","ts":"2021-08-26T16:12:08.205Z","logger":"eventlistener","caller":"sink/sink.go:213","msg":"interceptor stopped trigger processing: rpc error: code = FailedPrecondition desc = event type ping is not allowed","knative.dev/controller":"eventlistener","/triggers-eventid":"8e99abfc-f288-470b-b0dc-21e4167186fe","/trigger":"github-listener"}
----

We have to do the same for the `gateway` service… so annotate route to
the CD pipeline, the one triggered with PR that changes the image of
`gateway`.

[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc get route/el-gateway-cd-pl-pr-listener -n ${CICD_NAMESPACE} -o jsonpath='{.status.ingress[0].host}' && echo ""
----

Expect something like:

[.console-input]
[source,bash, subs="+macros,+attributes"]
----
el-gateway-cd-pl-pr-listener-gramola-cicd.apps.acme.com
----

Create Web Hook (click on Add Webhook) - Payload URL, the URL of the
route of the trigger listener you just got (don’t forget the `http://`
part, it’s NOT `https://`) - Type a secret… any thing should work -
Click on Let me…. and select Pull Requests and deselect Push Events…

Click on `Add webhook`

Let’s check the webhook is working:

[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc logs -f deployment/el-gateway-cd-pl-pr-listener -n ${CICD_NAMESPACE}
----

You should get something like this, pay attention to one of the last
lines saying *``event type ping is not allowed''*.

[.console-input]
[source,bash, subs="+macros,+attributes"]
----
...
{"level":"info","ts":"2021-08-26T16:16:56.921Z","logger":"eventlistener","caller":"sink/sink.go:213","msg":"interceptor stopped trigger processing: rpc error: code = FailedPrecondition desc = event type ping is not allowed","knative.dev/controller":"eventlistener","/triggers-eventid":"52fb39c6-40dc-431f-a155-224268ef95de","/trigger":"github-listener"}
----

== Useful commands

== Sync Root Apps alone

[.console-input]
[source,bash, subs="+macros,+attributes"]
----
argocd app sync gramola-root-app-dev
argocd app sync gramola-root-app-test
argocd app sync gramola-root-app-test-cloud
----

== Sync apps manually

[.console-input]
[source,bash, subs="+macros,+attributes"]
----
argocd app sync events-app-dev
argocd app sync events-app-test
argocd app sync events-app-test-cloud
----

== Sync children apps (app of apps)

[.console-input]
[source,bash, subs="+macros,+attributes"]
----
argocd app sync -l app.kubernetes.io/instance=gramola-root-app
argocd app sync -l app.kubernetes.io/instance=gramola-root-app-dev
argocd app sync -l app.kubernetes.io/instance=gramola-root-app-test
argocd app sync -l app.kubernetes.io/instance=gramola-root-app-test-cloud
----

== AUX

git clone
https://oauth2:1AbCDeF_g2HIJKLMNOPqr@gitlab.com/yourusername/project.git
project
