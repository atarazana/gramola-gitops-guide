<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Prepare Cluster :: Gramola GitOps Guide</title>
    <link rel="canonical" href="https://atarazana.github.io/gramola-gitops-guide/gramola-gitops-guide/02-prepare-cluster.html">
    <link rel="prev" href="01-setup.html">
    <link rel="next" href="03-prepare-repositories.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://atarazana.github.io/gramola-gitops-guide">Gramola GitOps Guide</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="gramola-gitops-guide" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">Gramola GitOps Guide</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html">1. Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#openshift">Setup OpenShift 4</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#container-registry-account">Container Registry Account</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#download-tutorial">Get tutorial sources</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-prepare-cluster.html">2. Prepare Cluster</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#deploying-argocd-and-tekton">Deploying ArgoCD &amp; Tekton</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#adding-project-definitions">Adding Project Definitions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#deploying-gitea">Deploying Gitea</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#create-git-users">Create Git Users</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-prepare-repositories.html">3. Prepare Repositories</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-prepare-repositories.html#explore-gitea-console">Explore Gitea console</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-prepare-repositories.html#create-git-pat">Create Git PAT</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-prepare-repositories.html#migrate-repositories">Migrate Repositories</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-prepare-argocd.html">4. Prepare ArgoCD</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-prepare-argocd.html#checking-argocd">Checking ArgoCD</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-prepare-argocd.html#log-in-argocd">Log in ArgoCD</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-prepare-argocd.html#register-repositories">Register Repositories</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-prepare-argocd.html#register-additional-clusters">Register Additional Clusters</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-prepare-argocd.html#add-project-definitions">Project definitions</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="05-deploy-gramola-with-gitops.html">5. Deploy Gramola</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-deploy-gramola-with-gitops.html#create-root-app">Create Root App</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-deploy-gramola-with-gitops.html#create-additional-root-app">Create Additional Root App</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="06-deploy-cicd-pipelines-with-gitops.html">6. Deploy CICD Pipelines</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-deploy-cicd-pipelines-with-gitops.html#create-pipelines-root-app">Create Pipelines Root App</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-deploy-cicd-pipelines-with-gitops.html#create-git-secret">Create Git Secret</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-deploy-cicd-pipelines-with-gitops.html#create-registry-secret">Create Registry Secret</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="07-setup-cicd-pipelines.html">7. Setup CICD Pipelines</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="07-setup-cicd-pipelines.html#checking-cicd-pipelines">Checking CICD Pipelines</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="07-setup-cicd-pipelines.html#create-pipelines-web-hooks">Create Pipelines Web Hooks</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="08-test-cicd-pipelines.html">8. Test CICD Pipelines</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08-test-cicd-pipelines.html#checking-cicd-pipelines">Checking CICD Pipelines</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="09-end-to-end-test.html">9. End to End Test</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="09-end-to-end-test.html#introduction">Introduction</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Gramola GitOps Guide</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Gramola GitOps Guide</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Gramola GitOps Guide</a></li>
    <li><a href="02-prepare-cluster.html">2. Prepare Cluster</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/atarazana/gramola-gitops-guide/edit/main/documentation/modules/ROOT/pages/02-prepare-cluster.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Prepare Cluster</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Everything we do in this section requires that you have fulfilled the <a href="01-setup.html#prerequisite" class="xref page">prerequisites</a> section and you&#8217;re logged in your OpenShift cluster.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>EVEN</strong> if you have two clusters and want to run the multicluster section&#8230;&#8203; so&#8230;&#8203; <strong>log in the main one now</strong> <span class="underline">not in the secondary</span>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>So if not already logged in, please do it now.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc login -u %USERNAME% -p %PASSWORD% --server=https://api.%BASE_SUBDOMAIN%:6443</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploying-argocd-and-tekton"><a class="anchor" href="#deploying-argocd-and-tekton"></a>Deploying ArgoCD and Tekton using the operators</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order to run this guide we&#8217;re going to need several components, more prominently:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>ArgoCD</strong>, the GitOps engine supported by Red Hat through the <strong>OpenShift GitOps operator</strong></p>
</li>
<li>
<p><strong>Tekton</strong>, the <em>de facto</em> kubernetes native CICD pipelines system supported by Red Hat through the <strong>OpenShift Pipelines operator</strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Install <strong>ArgoCD</strong> (with OpenShift OAuth configured) and <strong>Tekton</strong>:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">until kubectl apply -k util/bootstrap/; do sleep 2; done</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="high-level-tests"><a class="anchor" href="#high-level-tests"></a>High level tests</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s open the OpenShift Web Console and run some validation tests.</p>
</div>
<div class="paragraph">
<p>Open this link: <a href="https://console-openshift-console.apps.%BASE_SUBDOMAIN%" class="bare" target="_blank" rel="noopener">https://console-openshift-console.apps.%BASE_SUBDOMAIN%</a></p>
</div>
<div class="paragraph">
<p>You should see something like.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can skip the tour or run it if you want and have time.
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/openshift-console.png" alt="OpenShift Web Console">
</div>
</div>
<div class="paragraph">
<p>Now, take a look to the next picture, there are two arrows pointing to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The ArgoCD web console link</p>
</li>
<li>
<p>The Pipelines section</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/argocd-pipelines-test-1.png" alt="High level tests 1">
</div>
</div>
<div class="paragraph">
<p>You can see both then we&#8217;re on the good way.</p>
</div>
<div class="paragraph">
<p>Open the ArgoCD web console then click on the "LOG IN VIA OPENSHIFT" button on the upper right corner and use your credentials:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The first time you successfully log in you&#8217;ll see an Authorize Access request, leave it "as is"  and click on the button that says "Allow selected permissions"
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/argocd-login.png" alt="ArgoCD Log In">
</div>
</div>
<div class="paragraph">
<p>Finally if all went well you should land in the ArgoCD console and see this.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/argocd-console.png" alt="ArgoCD Console">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="adding-project-definitions"><a class="anchor" href="#adding-project-definitions"></a>Adding Project Definitions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ArgoCD can constrain which repositories and destinations can be linked with the definition of an application, in our case we are not constraining anything but we are still going to create project definitions to be prepared for future needs.</p>
</div>
<div class="paragraph">
<p>Execute these commands to create the Gramola project definitions:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f argocd/projects/project-dev.yml
kubectl apply -f argocd/projects/project-test.yml</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploying-gitea"><a class="anchor" href="#deploying-gitea"></a>Deploying Gitea using the operators</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Run this command to deploy the Gitea operator and Gitea itself in your OpenShift cluster.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Gitea will be installed in <code>gitea-system</code> namespace
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">until kubectl apply -k util/gitea/; do sleep 2; done</code></pre>
</div>
</div>
<div class="paragraph">
<p>The previous command will retry until it&#8217;s all installed but <strong>we still need to check if it all works properly</strong>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s have a look to the Gitea deployment object.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This command only works as expected once the Deployment object has been created by the operator, be patient and try again if you get.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">Error from server (NotFound): deployments.apps "repository" not found</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl rollout status deploy/repository -n gitea-system</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is the normal state after being successfully rolled out.</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">deployment "repository" successfully rolled out
oc get deployment/repository -n gitea-system
NAME         READY   UP-TO-DATE   AVAILABLE   AGE
repository   1/1     1            1           32m</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once Gitea has been rolled out, run this little smoke test.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -k -I <a href="https://repository-gitea-system.apps.%BASE_SUBDOMAIN%/" class="bare">https://repository-gitea-system.apps.%BASE_SUBDOMAIN%/</a></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You should get something like this. If you don&#8217;t, be patient and run this command in 2 mins or so.
</td>
</tr>
</table>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">HTTP/1.1 200 OK
set-cookie: i_like_gitea=82e42fd387b6ea7a; Path=/; HttpOnly; SameSite=Lax
date: Mon, 25 Oct 2021 08:06:22 GMT
set-cookie: 5b3fc896c2f6eedc568a6b59cd1862ea=23d42cb20150039ef52136e8993c6865; path=/; HttpOnly; Secure; SameSite=None
cache-control: private</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="create-git-users"><a class="anchor" href="#create-git-users"></a>Create Git Users</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that Gitea is installed and up and running, it&#8217;s time to add some users in the cluster, to do so we&#8217;re going to create a <code>Job</code> that will in it&#8217;s turn create 20 users.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kustomize build util/setup/ | sed -e 's/^  name\:.*$//g' | kubectl create -f -</code></pre>
</div>
</div>
<div class="paragraph">
<p>Have a look to the logs with:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">JOB_NAME=$(oc get job -n gitea-system -o jsonpath='{.items[0].metadata.name}')
oc logs -n gitea-system -f job/${JOB_NAME}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see something like:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">...
Creating user20
  {"id":21,"login":"user20","full_name":"User user20","email":"<a href="mailto:user20@example.com">user20@example.com</a>","avatar_url":"https://repository-gitea-system.apps.cluster-prhg6.prhg6.sandbox770.opentlc.com/avatar/3d67433db6e5deb7685759425360bafc","language":"","is_admin":false,"last_login":"1970-01-01T00:00:00Z","created":"2022-02-14T10:49:20Z","restricted":false,"active":true,"prohibit_login":false,"location":"","website":"","description":"","visibility":"public","followers_count":0,"following_count":0,"starred_repos_count":0,"username":"user20"}
------------------------------</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you just want to create one user do this.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Ignore error "Internal Server Error" user %USERNAME% should have been created.
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">GITEA_INSTALL_TOKEN=$(curl -k -s -XPOST -H "Content-Type: application/json"  -k -d '{"name":"install"}' -u %USERNAME%:%PASSWORD% <a href="https://repository-gitea-system.apps.%BASE_SUBDOMAIN%/api/v1/users/opentlc-mgr/tokens" class="bare">https://repository-gitea-system.apps.%BASE_SUBDOMAIN%/api/v1/users/opentlc-mgr/tokens</a> | jq -r .sha1)
echo "GITEA_INSTALL_TOKEN=${GITEA_INSTALL_TOKEN}"

curl -k -X 'POST' \
    "https://repository-gitea-system.apps.%BASE_SUBDOMAIN%/api/v1/admin/users?access_token=${GITEA_INSTALL_TOKEN}" \
    -H 'accept: application/json' \
    -H 'Content-Type: application/json' \
    -d '{
          "email": "%USERNAME%@example.com",
          "full_name": "User %USERNAME%",
          "login_name": "%USERNAME%",
          "must_change_password": false,
          "password": "%PASSWORD%",
          "send_notify": true,
          "source_id": 0,
          "username": "%USERNAME%",
          "visibility" : "public"
    }'</code></pre>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="01-setup.html" class="query-params-link">1. Setup</a></span>
  <span class="next"><a href="03-prepare-repositories.html" class="query-params-link">3. Prepare Repositories</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
