<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Deploy Gramola With GitOps :: Gramola GitOps Guide</title>
    <link rel="canonical" href="https://atarazana.github.io/gramola-gitops-guide/gramola-gitops-guide/05-deploy-gramola-with-gitops.html">
    <link rel="prev" href="04-prepare-argocd.html">
    <link rel="next" href="06-deploy-cicd-pipelines-with-gitops.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://atarazana.github.io/gramola-gitops-guide">Gramola GitOps Guide</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="gramola-gitops-guide" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">Gramola GitOps Guide</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html">1. Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#openshift">Setup OpenShift 4</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#container-registry-account">Container Registry Account</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#download-tutorial">Get tutorial sources</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-prepare-cluster.html">2. Prepare Cluster</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-prepare-cluster.html#deploying-core-components">Deploying core components</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-prepare-cluster.html#deploying-gitea">Deploying Gitea</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-prepare-cluster.html#create-git-users">Create Git Users</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-prepare-repositories.html">3. Prepare Repositories</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-prepare-repositories.html#explore-gitea-console">Explore Gitea console</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-prepare-repositories.html#create-git-pat">Create Git PAT</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-prepare-repositories.html#migrate-repositories">Migrate Repositories</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-prepare-argocd.html">4. Prepare ArgoCD</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-prepare-argocd.html#checking-argocd">Checking ArgoCD</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-prepare-argocd.html#log-in-argocd">Log in ArgoCD</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-prepare-argocd.html#register-repositories">Register Repositories</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-prepare-argocd.html#register-additional-clusters">Register Additional Clusters</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-prepare-argocd.html#add-project-definitions">Project definitions</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="05-deploy-gramola-with-gitops.html">5. Deploy Gramola</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#create-root-app">Create Root App</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#create-additional-root-app">Create Additional Root App</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="06-deploy-cicd-pipelines-with-gitops.html">6. Deploy CICD Pipelines</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-deploy-cicd-pipelines-with-gitops.html#create-pipelines-root-app">Create Pipelines Root App</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-deploy-cicd-pipelines-with-gitops.html#create-git-secret">Create Git Secret</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-deploy-cicd-pipelines-with-gitops.html#create-registry-secret">Create Registry Secret</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="07-checking-cicd-pipelines.html">7. Checking CICD Pipelines</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="07-checking-cicd-pipelines.html#overview">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="07-checking-cicd-pipelines.html#tekton-triggers">Tekton Triggers</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="08-create-pipeline-webhooks.html">8. Create Pipelines Webhooks</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08-create-pipeline-webhooks.html#pipeline-webhooks">Pipelines Webhooks</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08-create-pipeline-webhooks.html#create-ci-webhooks">Create CI Webhooks</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08-create-pipeline-webhooks.html#create-cd-webhooks">Create CD Webhooks</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="09-test-cicd-pipelines.html">9. Test CICD Pipelines</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="09-test-cicd-pipelines.html#checking-cicd-pipelines">Checking CICD Pipelines</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="10-end-to-end-test.html">10. End to End Test</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="10-end-to-end-test.html#introduction">Introduction</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Gramola GitOps Guide</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Gramola GitOps Guide</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Gramola GitOps Guide</a></li>
    <li><a href="05-deploy-gramola-with-gitops.html">5. Deploy Gramola</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/atarazana/gramola-gitops-guide/edit/main/documentation/modules/ROOT/pages/05-deploy-gramola-with-gitops.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Deploy Gramola With GitOps</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>As we have already explained in the introduction the main objective of this guide is introduce you to <strong>GitOps</strong> taking <strong>Gramola</strong> as the example application we want to deploy.</p>
</div>
<div class="paragraph">
<p>In this chapter you&#8217;re going to deploy Gramola using <strong>ArgoCD</strong> hence you&#8217;re not going to create the descriptors yourself. Instead <strong>ArgoCD</strong> will <strong>go</strong> to the <strong>source of truth</strong> (<em>git url, path and revision</em>), and  <strong>apply</strong> those descriptors in the defined <strong>destination</strong> (<em>cluster and namespace</em>).</p>
</div>
<div class="paragraph">
<p>As you can imagine there should be an object <strong>ArgoCD</strong> can rely on to store both <strong>spec&#8594;source</strong> and <strong>spec&#8594;destination</strong>, this object is the <code>Application</code> object. This is an example of an <code>Application</code> object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: events-app-dev-user1 <i class="conum" data-value="1"></i><b>(1)</b>
  namespace: openshift-gitops
  finalizers:
    - resources-finalizer.argocd.argoproj.io
  labels:
    app.kubernetes.io/instance: gramola-root-app-dev-user1
spec:
  project: gramola-project-dev
  source: <i class="conum" data-value="2"></i><b>(2)</b>
    repoURL: <a href="https://repository-gitea-system.apps.%BASE_SUBDOMAIN%/user1/gramola.git" class="bare">https://repository-gitea-system.apps.%BASE_SUBDOMAIN%/user1/gramola.git</a>
    targetRevision: HEAD
    path: events-deployment/overlays/dev
    plugin:
      name: kustomized-helm
      env:
        - name: DESTINATION_NAME
          value: in-cluster
        - name: BASE_REPO_URL
          value: <a href="https://repository-gitea-system.apps.%BASE_SUBDOMAIN%/user1/gramola" class="bare">https://repository-gitea-system.apps.%BASE_SUBDOMAIN%/user1/gramola</a>
        - name: NAMESPACE_SUFFIX
          value: '-user1'
  destination: <i class="conum" data-value="3"></i><b>(3)</b>
    name: in-cluster
    namespace: gramola-dev-user1
  syncPolicy:
    automated: {}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Name of the application</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Source of truth, git url, path, revision and plugin to use</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Defines the destination of the descriptors found in the source of truth</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As you usually need to define different</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="create-root-app"><a class="anchor" href="#create-root-app"></a>Create Root App</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ArgoCD uses a powerful abstraction of what an application is from the point of view of deployment descriptors. In an ArgoCD application we define where to look for the descriptors we want to create (<strong>spec&#8594;source</strong>) and maintain in Kubernetes and also how and where we want them (<strong>spec&#8594;destination</strong>). More over, because we can store Application objects also in git repository we could chain a set of applications with a parent application&#8230;&#8203; hence we can nest application and call "<strong>Root Application</strong>" to the top parent of a set of elements including Applications.</p>
</div>
<div class="paragraph">
<p>The next command creates a Root Application called <strong>gramola-root-app</strong> that points to our configuration repository <a href="https://repository-gitea-system.apps.%BASE_SUBDOMAIN%/%USERNAME%/gramola" class="bare" target="_blank" rel="noopener">https://repository-gitea-system.apps.%BASE_SUBDOMAIN%/%USERNAME%/gramola</a> and folder <strong>argocd/root-apps</strong>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Go <a href="https://argoproj.github.io/argo-cd/user-guide/helm/" target="_blank" rel="noopener">here</a> to learn more about the ArgoCD helm plugin.
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export USERNAME="%USERNAME%"
cat &lt;&lt;EOF | kubectl apply -n openshift-gitops -f -
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: gramola-${USERNAME}
  namespace: openshift-gitops
  labels:
    argocd-root-app: "true"
spec:
  generators:
  - list:
      elements:
      - env: dev
        desc: "Gramola Dev"
      - env: test
        desc: "Gramola Test"
  template:
    metadata:
      name: gramola-root-app-{{ env }}-${USERNAME}
      namespace: openshift-gitops
      labels:
        argocd-root-app: "true"
      finalizers:
      - resources-finalizer.argocd.argoproj.io
    spec:
      destination:
        namespace: openshift-gitops
        name: in-cluster
      project: default
      syncPolicy:
        automated:
          selfHeal: true
      source:
        helm:
          parameters:
            - name: baseRepoUrl
              value: <a href="https://repository-gitea-system.apps.%BASE_SUBDOMAIN%/%USERNAME%/gramola" class="bare">https://repository-gitea-system.apps.%BASE_SUBDOMAIN%/%USERNAME%/gramola</a>
            - name: namespaceSuffix
              value: "-${USERNAME}"
            - name: username
              value: "%USERNAME%"
        path: apps/{{ env }}
        repoURL: <a href="https://repository-gitea-system.apps.%BASE_SUBDOMAIN%/%USERNAME%/gramola.git" class="bare">https://repository-gitea-system.apps.%BASE_SUBDOMAIN%/%USERNAME%/gramola.git</a>
        targetRevision: HEAD
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see something like.</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">application.argoproj.io/gramola-root-app-user1 created</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="create-additional-root-app"><a class="anchor" href="#create-additional-root-app"></a>Create Additional Root App TODO!!!</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If an additional cluster has been set up&#8230;&#8203;</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export USERNAME="%USERNAME%"
cat &lt;&lt;EOF | kubectl apply -n openshift-gitops -f -
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: gramola-root-app-cloud-${USERNAME}
  namespace: openshift-gitops
  labels:
    argocd-root-app: "true"
  finalizers:
  - resources-finalizer.argocd.argoproj.io
spec:
  destination:
    namespace: openshift-gitops
    name: in-cluster
  project: default
  syncPolicy:
    automated: {}
  source:
    helm:
      parameters:
        - name: baseRepoUrl
          value: <a href="https://repository-gitea-system.apps.%BASE_SUBDOMAIN%/%USERNAME%/gramola" class="bare">https://repository-gitea-system.apps.%BASE_SUBDOMAIN%/%USERNAME%/gramola</a>
        - name: destinationName
          value: ${CLUSTER_NAME}
        - name: namespaceSuffix
          value: "-${USERNAME}"
        - name: username
          value: "%USERNAME%"
    path: argocd/root-apps-cloud
    repoURL: <a href="https://repository-gitea-system.apps.%BASE_SUBDOMAIN%/%USERNAME%/gramola" class="bare">https://repository-gitea-system.apps.%BASE_SUBDOMAIN%/%USERNAME%/gramola</a>
    targetRevision: HEAD
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similarly if you created the root app for the additional cluster you should see&#8230;&#8203;</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">application.argoproj.io/gramola-root-app-cloud-user1 created</code></pre>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="04-prepare-argocd.html" class="query-params-link">4. Prepare ArgoCD</a></span>
  <span class="next"><a href="06-deploy-cicd-pipelines-with-gitops.html" class="query-params-link">6. Deploy CICD Pipelines</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
